# Use Alpine only if onnxruntime-node supports it.
# Safer choice: Debian-based image.
FROM node:20-bullseye-slim

# Install system dependencies required by onnxruntime-node
RUN apt-get update && apt-get install -y \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy only package files first (better layer caching)
COPY package*.json ./

# Install production dependencies
RUN npm ci --omit=dev

# Copy application source
COPY pr-reviewer.js ./
COPY logger.js ./
COPY utils.js ./

# Environment variables
ENV PORT=3001
ENV BITBUCKET_TOKEN="BBDC-OTUxMzU5MjY1NzUyOj1qi1obF371UO/QcTrr/yhBbsJu"
ENV BITBUCKET_URL_PREFIX="http://bitbucket:7990/rest/api/1.0/projects/" 
ENV LLM_ENDPOINT="http://localhost:1234/v1/responses"
# "https://api.bitbucket.org/2.0/repositories/"

EXPOSE 3001

# Start the clustered server
CMD ["node", "pr-reviewer.js"]